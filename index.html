<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="630"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/7.6.0/polyfill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <title>MAP</title>
</head>
<body>
    <div class="container" id="app">
        <div class="taiwan-map" ref="map">
          <div id="map">
            <svg id="svg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet" height="100%"></svg>
          </div>
        </div>
        <div class="shop-list">
          <h1>{{ h1 }}</h1>
          <h2>{{ h2 }}</h2>
        </div>
      </div>
</body>
<style>
html,body,.container{
  width: 100%;
  height: 100%;
  overflow: hidden;
}
.container {
    display: -webkit-box;
    display: flex;
    justify-content: space-around;
}
#map{
    display: flex;
    -webkit-box-pack: center;
    justify-content: center;
    -webkit-box-align: center;
    align-items: center;
    width: 100%;
    height: 100%;
}
.shop-list{
    display: flex;
    -webkit-box-pack: center;
    justify-content: center;
    -webkit-box-align: center;
    align-items: center;
    align-content: center;
    flex-wrap: wrap;
    text-align: center;
}
.taiwan-map,.shop-list{
    width: 50%;
    height: 100%;
    display: inline-block;
}

#map svg {
    max-height: 100vh;
}
.point{
    width: 5px;
    height: 5px;
    background-color: brown;
    border-radius: 50%;
    display: inline-block;
}
</style>
<script>

const TaiwanMap = new Vue({
  el: '#app',
  data: {
    h1: '縣市中文',
    h2: '縣市英文'
  },
  methods: {
    async getTaiwanMap() {
      const width = (this.$refs.map.offsetWidth).toFixed(),
            height = (this.$refs.map.offsetHeight).toFixed() <700 ? 700 : (this.$refs.map.offsetHeight).toFixed();

      // 判斷螢幕寬度，給不同放大值
      let mercatorScale, w = window.screen.width;
      if(w > 1366) {
        mercatorScale = 11000;
      }
      else if(w <= 1366 && w > 480) {
        mercatorScale = 9000;
      }
      else {
        mercatorScale = 6000;
      }
      var projection = await d3.geo.mercator().center([121,24])
          .scale(mercatorScale)
          .translate([width/2, height/2.5]);
      // d3：svg path 產生器
      var path = await d3.geo.path().projection(
        // !important 座標變換函式
        projection
      );
      
      // 讓d3抓svg，並寫入寬高
      var svg = await d3.select('#svg')
          .attr('width', width)
          .attr('height', height)
          .attr('viewBox', `0 0 ${width} ${height}`);
      
      // 讓d3抓GeoJSON檔，並寫入path的路徑
      var url = 'dist/COUNTY_MOI_1081121.geojson';
      await d3.json(url, (error, geometry) => {
        if (error) throw error;

        svg
          .selectAll('path')
          .data(geometry.features)
          .enter().append('path')
          .attr('d', path)
          .attr({
            // 設定id，為了click時加class用
            id: (d) => 'city' + d.properties.COUNTYCODE
          })
          .on('click', d => {
            this.h1 = d.properties.COUNTYNAME; // 換中文名
            this.h2 = d.properties.COUNTYENG; // 換英文名
            // 有 .active 存在，就移除 .active
            if(document.querySelector('.active')) {
              document.querySelector('.active').classList.remove('active');
            }
            // 被點擊的縣市加上 .active
            document.getElementById('city' + d.properties.COUNTYCODE).classList.add('active');
          });
          var test_url = 'dist/points.json';
          var aa = [121.544742
                    , 25.050063];
         d3.json(test_url, (error, geometry) => {
         

            console.log(geometry.features);
         svg.selectAll('circle')
             .data(geometry.features.geometry.coordinates)
             .enter().append('circle')
             .attr("cx", function (d) { return projection(d)[0]; })
             .attr("cy", function (d) { console.log(d); return projection(d)[1]; })
             .attr("r", "8px")
             .attr("fill", "red")


            });


      });
      return svg;
    },
    async getpoint(){
        var url = 'dist/points.json';
        var svg = await d3.select('#svg');
            // points
        var aa = [121.544742,
                    , 25.050063];
        var bb = [-122.389809, 37.72728];
        const width = (this.$refs.map.offsetWidth).toFixed(),
            height = (this.$refs.map.offsetHeight).toFixed();
              // 判斷螢幕寬度，給不同放大值
      let mercatorScale, w = window.screen.width;
      if(w > 1366) {
        mercatorScale = 11000;
      }
      else if(w <= 1366 && w > 480) {
        mercatorScale = 9000;
      }
      else {
        mercatorScale = 6000;
      }
        var projection = d3.geo.mercator().center([121,24])
          .scale(mercatorScale)
          .translate([width/2, height/2.5]);
        console.log(projection);
        await d3.json(url, (error, geometry) => {
            if (error) throw error;
            console.log();
            svg
             .selectAll('circle')
             .data([aa])
             .enter().append('circle')
             .attr("cx", function (d) { return projection(d)[0]; })
             .attr("cy", function (d) { return projection(d)[1]; })
             .attr("r", "8px")
             .attr("fill", "red")
            
        });

        return svg;
    }
  },
  mounted() {

    this.getTaiwanMap();
   // this.getpoint();
  }
})


</script>
</html>