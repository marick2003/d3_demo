<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="630"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/7.6.0/polyfill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.js"></script>
    <script src="https://unpkg.com/vue-select@3.0.2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
    <script src="https://d3js.org/d3.v3.min.js"></script>
    
    <title>MAP</title>
</head>
<body>
    <div class="container" id="app">
        <div class="taiwan-map" ref="map">
          <div id="map">
            <svg id="svg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet" height="100%"></svg>
          </div>
        </div>
        <div class="shop-list">
          <h1>{{ h1 }}</h1>
          <h2>{{ h2 }}</h2>
          <select @change="onChange($event)">
            <option value="0" disabled selected>--請選擇--</option>
            <option v-for="option in citys" v-bind:value="option" >
              {{ option }}
            </option>
          </select>
        </div>
        <div class="info"> 
           {{ detail }}
        </div>
      </div>
</body>
<style>
html,body,.container{
  width: 100%;
  height: 100%;
  overflow: hidden;
}
.svg_color{
    fill: #F6831D;
    stroke-dashoffset: 0;
    stroke-dasharray: 700;
    stroke-width: 2;
    stroke: black;
}
.container {
    display: -webkit-box;
    display: flex;
    justify-content: space-around;
}
#map{
    display: flex;
    -webkit-box-pack: center;
    justify-content: center;
    -webkit-box-align: center;
    align-items: center;
    width: 100%;
    height: 100%;
}
.shop-list{
    display: flex;
    -webkit-box-pack: center;
    justify-content: center;
    -webkit-box-align: center;
    align-items: center;
    align-content: center;
    flex-wrap: wrap;
    text-align: center;
}
.taiwan-map{
    width: 80%;
    height: 100%;
    display: inline-block;
}
.shop-list{
    width: 20%;
    height: 100%;
    display: inherit;
}

#map svg {
    max-height: 100vh;
}
.point{
    width: 5px;
    height: 5px;
    background-color: brown;
    border-radius: 50%;
    display: inline-block;
}
</style>
<script>
Vue.component('v-select', VueSelect.VueSelect)

const TaiwanMap = new Vue({
  el: '#app',
  data: {
    h1: '縣市中文',
    h2: '縣市英文',
    detail: '',
    citys:[],
    circle_svg2: {},
    projection:{}, 
  },
  methods: {
    async getTaiwanMap() {
      const width = (this.$refs.map.offsetWidth).toFixed(),
            height = (this.$refs.map.offsetHeight).toFixed() <700 ? 700 : (this.$refs.map.offsetHeight).toFixed();

      // 判斷螢幕寬度，給不同放大值
      let mercatorScale, w = window.screen.width;
      if(w > 1366) {
        mercatorScale = 11000;
      }
      else if(w <= 1366 && w > 480) {
        mercatorScale = 9000;
      }
      else {
        mercatorScale = 6000;
      }
       this.projection = await d3.geo.mercator().center([121,24])
          .scale(mercatorScale)
          .translate([width/2, height/2.5]);
      // d3：svg path 產生器
      var path = await d3.geo.path().projection(
        // !important 座標變換函式
        this.projection
      );
      
      // 讓d3抓svg，並寫入寬高
      var svg = await d3.select('#svg')
          .attr('width', width)
          .attr('height', height)
          .attr('viewBox', `0 0 ${width} ${height}`);
      
      // 讓d3抓GeoJSON檔，並寫入path的路徑
      var url = 'dist/COUNTY_MOI_1081121.geojson';
      await d3.json(url, (error, geometry) => {
        if (error) throw error;
        for (x in geometry.features) {
          console.log(geometry.features[x].properties.COUNTYNAME);
          this.citys.push(geometry.features[x].properties.COUNTYNAME);
        }
        console.log(this.citys);
       // console.log(geometry.features);
        // Object.keys(geometry.features.properties).forEach(function(key) {
        // console.table('Key : ' + key + ', Value : ' + geometry.features.properties[key])
    
        svg
          .selectAll('path')
          .data(geometry.features)
          .enter().append('path')
          .attr('d', path)
          .attr('class',"svg_color")
          .attr({
            // 設定id，為了click時加class用
            id: (d) => 'city' + d.properties.COUNTYCODE
          })
          .on('click', d => {
            this.h1 = d.properties.COUNTYNAME; // 換中文名
            this.h2 = d.properties.COUNTYENG; // 換英文名
            // 有 .active 存在，就移除 .active
            if(document.querySelector('.active')) {
              document.querySelector('.active').classList.remove('active');
            }
            // 被點擊的縣市加上 .active
            document.getElementById('city' + d.properties.COUNTYCODE).classList.add('active');
          });
         
          var aa = [121.544742 , 25.050063];
          
      });
      return svg;
    },
    async getpoint(city_name){
      var _this= this;
      //https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json
      //dist/points.json
      var test_url = 'https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json';
      var circle_svg= await d3.select('#svg')
         d3.json(test_url, (error, geometry) => {
            var _data=[];
            for (x in geometry.features) {
              if(city_name==geometry.features[x].properties.county){
                _data.push(geometry.features[x]);
              }
              
            }
            console.log(_data);
            
            let circle = circle_svg.selectAll('circle');
            let update = circle.data(_data);
            let enter = update.enter();
            let exit = update.exit();

            update
              .attr("cx", function(d, i) {
                return _this.projection(d.geometry.coordinates)[0]; })
              .attr("cy", function (d) {  return _this.projection(d.geometry.coordinates)[1]; })
              .attr("r", "4px")
              .attr("fill", "red");

            enter
              .append("circle")
              .attr("cx", function(d, i) {
                return _this.projection(d.geometry.coordinates)[0]; })
              .attr("cy", function (d) {  return _this.projection(d.geometry.coordinates)[1]; })
              .attr("r", "4px")
              .attr("fill", "red");
            exit.remove();
            
          });
           
    },
    onChange(event){

      console.log(event.target.value);
      this.getpoint(event.target.value);

    }
  },
  mounted() {

    this.getTaiwanMap();
  }
})


</script>
</html>